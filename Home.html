<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>BudgetMaster (YNAB-Inspired Interface)</title>
 <style>
  :root {
    --bg: #f5f7fa;
    --card: #ffffff;
    --radius: 16px;
    --shadow: 0 12px 40px -10px rgba(0, 0, 0, 0.08);
    --accent: #6366f1;
    --border: 1px solid rgba(0, 0, 0, 0.05);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
  }
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    background: var(--bg);
    color: #1f2d3a;
  }
  .app {
    display: grid;
    grid-template-columns: 260px 1fr;
    min-height: 100vh;
  }
  .sidebar {
    background: #1f2d3a;
    color: #fff;
    display: flex;
    flex-direction: column;
  }
  .sidebar-header {
    padding: 1rem;
    font-size: 1.25rem;
    font-weight: 600;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  .nav {
    flex: 1;
    overflow: auto;
    padding: 0.5rem;
  }
  .nav button {
    display: flex;
    align-items: center;
    width: 100%;
    background: none;
    border: none;
    color: inherit;
    padding: 10px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.95rem;
    margin-bottom: 4px;
    transition: background .2s;
  }
  .nav button.active,
  .nav button:hover {
    background: rgba(255, 255, 255, 0.08);
  }
  .main {
    padding: 24px;
    overflow: auto;
  }
  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    gap: 12px;
    flex-wrap: wrap;
  }
  .btn {
    padding: 10px 16px;
    border: none;
    cursor: pointer;
    border-radius: 10px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .btn-primary {
    background: var(--accent);
    color: #fff;
  }
  .btn-outline {
    background: none;
    border: 2px solid var(--accent);
    color: var(--accent);
  }
  .card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 18px;
    box-shadow: var(--shadow);
    margin-bottom: 16px;
  }
  .flex {
    display: flex;
  }
  .gap {
    gap: 16px;
  }
  .budget-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    margin-top: 8px;
  }
  .budget-item {
    border: var(--border);
    border-radius: 12px;
    position: relative;
    padding: 14px;
    margin-bottom: 12px;
    background: #fff;
  }
  .item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
  }
  .pill {
    background: rgba(99, 102, 241, 0.15);
    color: var(--accent);
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
  }
  .amounts {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-top: 6px;
  }
  .small {
    font-size: 0.75rem;
    color: #6b7280;
  }
  .transactions {
    margin-top: 8px;
  }
  .transaction {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
  }
  .badge {
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 11px;
    background: #e2e8f0;
  }
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(31, 45, 58, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5;
  }




  .modal {
    background: #fff;
    border-radius: 14px;
    max-width: 540px;
    width: 100%;
    padding: 24px;
    position: relative;
  }
  .close-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
  }
  .input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.95rem;
    margin-top: 4px;
  }
  .split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .status {
    font-weight: 700;
  }
  .budget-summary {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  .pill-small {
    background: #f3f4f6;
    color: #374151;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 12px;
    margin-right: 6px;
  }
  .overflow {
    overflow: auto;
  }
  .warning {
    color: #b91c1c;
    font-size: 0.85rem;
    margin-top: 6px;
  }

/* 📊 Reports Section Styles */
/* Reports Section Container */
.report-container {
  display: flex;
  flex-direction: column;
  gap: 2rem;
  padding: 1.5rem;
  background: var(--bg-main, #f9fafb);
}

/* Card Style */
.report-card {
  background: var(--card-bg, #fff);
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.report-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 24px rgba(0,0,0,0.12);
}

/* Header for Summary */
.summary-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}
.summary-controls {
  display: flex;
  gap: 0.8rem;
}
.input-month {
  padding: 0.5rem 0.8rem;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  background: #fff;
}
.btn-download {
  background: linear-gradient(90deg, #007aff, #0051a8);
  color: #fff;
  border: none;
  padding: 0.5rem 0.9rem;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s ease;
}
.btn-download:hover {
  background: linear-gradient(90deg, #0051a8, #003d7a);
}

/* Monthly Summary Section */
.summary-content {
  margin-top: 1rem;
  padding: 1rem;
  background: #f3f4f6;
  border-radius: 12px;
  font-size: 0.95rem;
}

/* Charts Row Layout */
.charts-row {
  display: flex;
  gap: 1.5rem;
  flex-wrap: wrap;
}
.small-chart {
  flex: 1;
  min-width: 300px;
}

/* Chart Canvas Styling */
.chart-container {
  position: relative;
  height: 280px;
  width: 100%;
}
.chart-container canvas {
  width: 100% !important;
  height: 100% !important;
  border-radius: 12px;
  background: #fff;
}

/* Detailed Transactions Table */
.report-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 16px rgba(0,0,0,0.05);
  font-size: 0.95rem;
}

.report-table thead {
  background: linear-gradient(90deg, #007aff, #0051a8);
  color: #fff;
}

.report-table th {
  padding: 0.9rem 1rem;
  text-align: left;
  font-weight: 600;
}

.report-table tbody tr {
  border-bottom: 1px solid #e5e7eb;
  transition: background 0.15s ease;
}

.report-table tbody tr:hover {
  background: #f9fafb;
}

.report-table td {
  padding: 0.8rem 1rem;
  color: #374151;
}

/* Zebra striping */
.report-table tbody tr:nth-child(even) {
  background: #f8fafc;
}

/* No Data Message */
.report-table-empty {
  text-align: center;
  padding: 1rem;
  color: #6b7280;
  font-style: italic;
}
















/* Responsive */
@media (max-width: 1024px) {
  .charts-row {
    flex-direction: column;
  }
}



/* Table Styling */
.budget-table-container {
  overflow-x: auto;
  border-radius: var(--radius);
  border: var(--border);
}

.budget-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 0.95rem;
}

.budget-table thead {
  background: #f3f4f6;
}

.budget-table th {
  text-align: left;
  padding: 12px 16px;
  font-weight: 600;
  color: #374151;
}

.budget-table td {
  padding: 12px 16px;
  border-top: var(--border);
}

.budget-table tr:hover {
  background: #f9fafb;
}

/* Amount Colors */
.amount {
  text-align: right;
  font-weight: 500;
}

.amount.positive {
  color: #15803d;
}

.amount.negative {
  color: #b91c1c;
}

.amount.neutral {
  color: #4b5563;
}

/* Action Buttons */
.actions {
  text-align: center;
  white-space: nowrap;
}

.small-btn {
  padding: 6px 10px;
  font-size: 0.8rem;
  border-radius: 6px;
}

.btn-danger {
  background: #fee2e2;
  color: #b91c1c;
  border: 1px solid #fecaca;
}

.btn-danger:hover {
  background: #fecaca;
}

#logoutBtn:hover {
    color: #e53e3e; /* Red on hover */
  }

</style>


</head>
<body>
  <div class="app">
 <aside class="sidebar" style="color: white; background: #1e40af; width: 250px; padding: 16px; box-sizing: border-box;">
  <div class="sidebar-header" 
       style="display: flex; align-items: center; justify-content: space-between; font-weight: bold; font-size: 1.2em; padding-right: 12px;">
    BudgetMaster
    <button id="logoutBtn" title="Logout" 
      style="background:none; border:none; cursor:pointer; color:#fff; transition: color 0.3s; font-size: 22px; display: flex; align-items: center; padding: 0;">
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" width="22" height="22" viewBox="0 0 24 24">
        <path d="M16 13v-2H7V8l-5 4 5 4v-3zM20 3H8c-1.1 0-2 .9-2 2v4h2V5h12v14H8v-4H6v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
      </svg>
    </button>
  </div>
  
  <div class="nav" style="margin-top: 20px;">
    <button class="active" data-section="overview">Overview</button>
    <button data-section="budgets">Budgets</button>
    <button data-section="accounts">Accounts</button>
    <button data-section="reports">Reports</button>
    <button data-section="settings">Settings</button>
  </div>
  
  <div style="padding:14px; border-top:1px solid rgba(255,255,255,0.1); font-size:12px; margin-top: auto;">
    Inspired by rule-based budgeting.
  </div>
</aside>


<main class="main">
  <div class="topbar">
    <div style="font-size:1.75rem;font-weight:600;">Your Budget</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-outline" id="add-item-btn">+ Add Budget Item</button>
      <button class="btn btn-primary" id="add-transaction-btn">+ Add Transaction</button>
      <button class="btn btn-success" id="add-income-btn">+ Add Income</button>
    </div>
  </div>


<!-- Overview Section -->
<div class="section" data-section-id="overview">
  <div class="card budget-summary">
    <div style="flex:1;min-width:200px;position:relative;">
      <div class="small">Total Budget Pool</div>
      <div style="font-size:1.35rem;font-weight:700;" id="total-pool-display"></div>
      <div style="position:absolute;top:4px;right:4px;">
        <button class="btn" id="edit-pool-btn" style="padding:6px 10px;font-size:0.65rem;">Edit Pool</button>
      </div>
    </div>

    <!-- ✅ Newly added block for Available Cash -->
    <div style="flex:1;min-width:200px;">
      <div class="small">Available Cash</div>
      <div style="font-size:1.35rem;font-weight:700;" id="available-cash-display"></div>
    </div>

    <div style="flex:1;min-width:200px;">
      <div class="small">Assigned</div>
      <div style="font-size:1.35rem;font-weight:700;" id="total-assigned-display"></div>
    </div>
    <div style="flex:1;min-width:200px;">
      <div class="small">To Be Budgeted</div>
      <div style="font-size:1.35rem;font-weight:700;" id="available-to-assign-display"></div>
    </div>
    <div style="flex:1;min-width:200px;">
      <div class="small">Overspent</div>
      <div style="font-size:1.35rem;font-weight:700;color:#dc2626;" id="overspent-display"></div>
    </div>
  </div>


        <!-- Budget Items -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div style="font-weight:600;font-size:1.1rem;">Budget Items</div>
            <div><span class="pill-small">Assign directly from pool</span></div>
          </div>
          <div class="budget-grid" id="items-container"></div>
        </div>

        <!-- Recent Transactions -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div style="font-weight:600;font-size:1.1rem;">Recent Transactions</div>
            <div><button class="btn btn-outline" id="view-all-transactions">View All</button></div>
          </div>
          <div id="transactions-list"></div>
        </div>
      </div>



<!-- Budgets Section -->
<div class="section" data-section-id="budgets" style="display:none;">
  <div class="card">
    <!-- Header Section -->
    <div class="topbar">
      <h2>Manage Budget Categories</h2>
      <div class="flex gap">
        <select id="budget-month-selector" class="btn btn-outline">
          <!-- JS populates months -->
        </select>
        <button class="btn btn-primary" id="add-budget-category">+ New Category</button>
      </div>
    </div>

    <!-- Table Container -->
    <div class="budget-table-container">
      <table id="budgets-management" class="budget-table">
        <thead>
          <tr>
            <th>Category</th>
            <th>Assigned</th>
            <th>Activity</th>
            <th>Available</th>
            <th style="text-align:center;">Actions</th>
          </tr>
        </thead>
        <tbody id="budget-category-list">
          <!-- Example Row -->
          <tr>
            <td>Groceries</td>
            <td class="amount">$500</td>
            <td class="amount negative">- $120</td>
            <td class="amount positive">$380</td>
            <td class="actions">
              <button class="btn btn-outline small-btn">Edit</button>
              <button class="btn btn-danger small-btn">Delete</button>
            </td>
          </tr>
          <tr>
            <td>Rent</td>
            <td class="amount">$1,200</td>
            <td class="amount neutral">$0</td>
            <td class="amount positive">$1,200</td>
            <td class="actions">
              <button class="btn btn-outline small-btn">Edit</button>
              <button class="btn btn-danger small-btn">Delete</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>






      <!-- Accounts Tab -->
      <div class="section" data-section-id="accounts" style="display:none;">
        <div class="card">
          <h2>Accounts</h2>
          <div id="accounts-list"></div>
          <button class="btn btn-primary" id="add-account">+ Add Account</button>
        </div>
      </div>


<!-- 📊 Reports Tab -->
<div class="section" data-section-id="reports" style="display: none;">
  <div class="report-container">
    
    <!-- Monthly Summary Card -->
    <div class="report-card monthly-summary">
      <div class="summary-header">
        <h2 class="report-title">🗓 Monthly Summary</h2>
        <div class="summary-controls">
          <select id="report-month-selector" class="input-month"></select>
          <button id="download-report-btn" class="btn-download">⬇ Download Report</button>
        </div>
      </div>
      <div id="monthly-summary" class="summary-content"></div>
    </div>

    <!-- Charts Row -->
    <div class="charts-row">
      <div class="report-card small-chart">
        <h2 class="report-title">📈 Spending Chart</h2>
        <div class="chart-container">
          <canvas id="spending-chart"></canvas>
        </div>
      </div>

      <div class="report-card small-chart">
        <h2 class="report-title">💰 Income Chart</h2>
        <div class="chart-container">
          <canvas id="income-chart"></canvas>
        </div>
      </div>

      <div class="report-card small-chart">
        <h2 class="report-title">📊 Category Breakdown</h2>
        <div class="chart-container">
          <canvas id="category-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Detailed Transactions Table -->
    <div class="report-card">
      <h3 class="report-title">Detailed Transactions</h3>
      <div class="table-container" style="overflow-x:auto;">
        <table class="report-table" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="padding:8px; border-bottom:1px solid #ddd;">Date</th>
              <th style="padding:8px; border-bottom:1px solid #ddd;">Category</th>
              <th style="padding:8px; border-bottom:1px solid #ddd;">Description</th>
              <th style="padding:8px; border-bottom:1px solid #ddd;">Amount</th>
              <th style="padding:8px; border-bottom:1px solid #ddd;">Type</th>
            </tr>
          </thead>
          <tbody id="reportTableBody">
            <tr>
              <td colspan="5" style="text-align:center; padding:10px; color:#888;">No data available</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- Settings Tab -->
<div class="section" data-section-id="settings" style="display:none;">
  <div class="card">
    <h2>Settings</h2>
    <div class="setting-item">
      <label for="currency-selector">Currency</label>
      <select id="currency-selector" class="input">
        <option value="PHP">₱ PHP</option>
        <option value="USD">$ USD</option>
        <option value="EUR">€ EUR</option>
        <option value="GBP">£ GBP</option>
        <option value="KES">KES</option>
      </select>
    </div>
    <div class="setting-item">
      <label for="toggle-dark-mode">Dark Mode</label>
      <input type="checkbox" id="toggle-dark-mode" />
    </div>

    <div style="margin-top:24px;">
      <button class="btn btn-outline" id="delete-data">Delete All Data</button>
      <!-- Add this Save button -->
      <button class="btn btn-primary" id="save-settings" style="margin-left:12px;">Save Settings</button>
    </div>
  </div>
</div>






<!-- 🌐 Pool Modal -->
<div class="modal-backdrop" id="pool-modal" style="display:none;">
  <div class="modal">
    <button class="close-btn" data-close>&times;</button>
    <h2 style="margin-top:0;">Set Available Money</h2>
    <div>
      <label>Available Budget Pool</label>
      <input type="number" id="pool-input" class="input" placeholder="5000" />
    </div>
    <div style="margin-top:14px;text-align:right;">
      <button class="btn" id="cancel-pool">Cancel</button>
      <button class="btn btn-primary" id="save-pool">Save</button>
    </div>
  </div>
</div>


 <!-- ➕ Add Budget Item Modal -->
<div class="modal-backdrop" id="item-modal" style="display:none;">
  <div class="modal">
    <button class="close-btn" data-close>&times;</button>
    <h2 style="margin-top:0;">Add Budget Item</h2>
    <div class="split">
      <div>
        <label>Item Name</label>
        <input type="text" id="new-item-name" class="input" placeholder="Groceries" />
      </div>
      <div>
        <label>Assigned Amount</label>
        <input type="number" id="new-item-amount" class="input" placeholder="500" />
      </div>
    </div>
    <div id="item-warning" class="warning" style="display:none;">Assigned amount exceeds available pool.</div>
    <div style="margin-top:14px;text-align:right;">
      <button class="btn" id="cancel-new-item">Cancel</button>
      <button class="btn btn-primary" id="save-new-item">Save Item</button>
    </div>
  </div>
</div>


<!-- 💸 Add Transaction Modal -->
<div class="modal-backdrop" id="transaction-modal" style="display:none;">
  <div class="modal">
    <button class="close-btn" data-close>&times;</button>
    <h2 style="margin-top:0;">New Transaction</h2>
    <div class="split">
      <div>
        <label>Payee</label>
        <input type="text" id="tx-payee" class="input" placeholder="Supermarket" />
      </div>
      <div>
        <label>Amount</label>
        <input type="number" id="tx-amount" class="input" placeholder="-45.99" />
      </div>
    </div>
    <div style="margin-top:12px;">
      <label>Budget Item</label>
      <select id="tx-item" class="input"></select>
    </div>
    <div style="margin-top:12px;">
      <label>Date</label>
      <input type="date" id="tx-date" class="input" />
    </div>
    <div style="margin-top:14px;text-align:right;">
      <button class="btn" id="cancel-tx">Cancel</button>
      <button class="btn btn-primary" id="save-tx">Save Transaction</button>
    </div>
  </div>
</div>

<!-- ➕ Add Income Modal (matches other modal style) -->
<div class="modal-backdrop" id="income-modal" style="display:none;">
  <div class="modal">
    <button class="close-btn" id="income-close-btn" data-close>&times;</button>
    <h2 style="margin-top:0;">Add Income</h2>

    <div class="split">
      <div>
        <label>Date</label>
        <input type="date" id="income-date" class="input" />
      </div>
      <div>
        <label>Amount</label>
        <input type="number" id="income-amount" class="input" step="0.01" min="0" placeholder="0.00" />
      </div>
    </div>

    <div style="margin-top:12px;">
      <label>Description</label>
      <input type="text" id="income-description" class="input" placeholder="E.g. Salary, Gift, Bonus" />
    </div>

    <div style="margin-top:14px;text-align:right;">
      <button class="btn" id="cancel-income">Cancel</button>
      <button class="btn btn-primary" id="save-income">Add Income</button>
    </div>
  </div>
</div>









<!-- 🏦 Add Account Modal -->
<div class="modal-backdrop" id="account-modal" style="display:none;">
  <div class="modal">
    <button class="close-btn" data-close>&times;</button>
    <h2 style="margin-top:0;">Add Account</h2>

    <div>
      <label>Account Name</label>
      <input type="text" id="account-name" class="input" placeholder="e.g. BDO Checking" />
      <div class="warning" id="account-name-warning" style="display:none;">Please enter a valid account name.</div>
    </div>

    <div style="margin-top:12px;">
      <label>Initial Balance</label>
      <input type="number" id="account-balance" class="input" placeholder="10000" />
      <div class="warning" id="account-balance-warning" style="display:none;">Please enter a valid number.</div>
    </div>

    <div style="margin-top:14px;text-align:right;">
      <button class="btn" id="cancel-account">Cancel</button>
      <button class="btn btn-primary" id="save-account">Save Account</button>
    </div>
  </div>
</div>







<!-- ⚙️ Settings Modal -->
<div class="modal-backdrop" id="settings-modal" style="display:none;">
  <div class="modal">
    <button class="close-btn" data-close>&times;</button>
    <h2 style="margin-top:0;">Settings</h2>

    <div>
      <label>Currency</label>
     <select id="currency-selector" class="input">
  <option value="PHP">₱ PHP</option>
  <option value="USD">$ USD</option>
  <option value="EUR">€ EUR</option>
</select>

    </div>

    <div style="margin-top:12px;">
      <label>Theme</label>
      <select id="theme-select" class="input">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </div>

    <div style="margin-top:20px;">
      <button class="btn btn-danger" id="reset-app">Reset All Data</button>
    </div>

    <div style="margin-top:14px;text-align:right;">
      <button class="btn" id="cancel-settings">Cancel</button>
      <button class="btn btn-primary" id="save-settings">Save Settings</button>
    </div>
  </div>
</div>














<!-- 🧩 Budget Item Template -->
<template id="item-template">
  <div class="card budget-item">
    <div class="item-header">
      <div class="title" data-name style="font-weight:600;"></div>
      <div class="pill" data-goal></div>
    </div>
    <div class="amounts">
      <div><div class="small">Assigned</div><div class="status" data-assigned>$0</div></div>
      <div><div class="small">Spent</div><div class="status" data-spent>$0</div></div>
      <div><div class="small">Available</div><div class="status" data-available>$0</div></div>
    </div>
    <div class="transactions" data-transactions></div>
  </div>
</template>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>  <!-- Added auth compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // --- Firebase Setup ---
  const firebaseConfig = {
    apiKey: "AIzaSyC5Spnd6pFGrLAcNxsX6X0LMxSp3XojL8A",
    authDomain: "budget-monitoring-99949.firebaseapp.com",
    projectId: "budget-monitoring-99949",
    storageBucket: "budget-monitoring-99949.appspot.com",
    messagingSenderId: "290972976511",
    appId: "1:290972976511:web:64c11ab518265572d1864a"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();  // <-- Auth initialized here
  const db = firebase.firestore();

// --- Session check: Validate active session ---
// --- Session check: Validate active session ---
firebase.auth().onAuthStateChanged(async (user) => {
  if (user) {
    const uid = user.uid;

    async function migrateLocalStorageToFirestore(uid) {
      const categories = JSON.parse(localStorage.getItem("categories") || "[]");
      const transactionsLS = JSON.parse(localStorage.getItem("transactions") || "[]");
      const accountsLS = JSON.parse(localStorage.getItem("accounts") || "[]");
      const pool = Number(localStorage.getItem("pool") || 0);
      const settings = JSON.parse(localStorage.getItem("settings") || "{}");

      // Skip if nothing to migrate
      if (
        !categories.length &&
        !transactionsLS.length &&
        !accountsLS.length &&
        pool === 0 &&
        Object.keys(settings).length === 0
      ) {
        console.log("No localStorage data to migrate.");
        return;
      }

      const payload = {
        categories,
        transactions: transactionsLS,
        accounts: accountsLS,
        pool,
        settings,
        migratedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection("users").doc(uid)
          .collection("appData").doc("budgetData")
          .set(payload, { merge: true });

        console.log("✅ Migrated localStorage to Firestore.");

        // Clear localStorage after successful migration
        ["categories", "transactions", "accounts", "pool", "settings"].forEach(k => localStorage.removeItem(k));
        console.log("🧹 Cleared migrated localStorage data.");
        
      } catch (err) {
        console.error("❌ Migration failed:", err);
      }
    }

    // Run migration
    await migrateLocalStorageToFirestore(uid);

    console.log("🔑 User logged in:", user.email);
  } else {
    console.log("🚪 User signed out.");
  }
});
















  // --- App State ---
  const budgetItems = [];
  const transactions = [];
  const accounts = [];

  let budgetPool = 0;
  let editingItemIndex = null;

  // Global variables for currency
  let currencyCode = 'PHP';
  let currencySymbol = '₱';

  // Format function using dynamic symbol
  const fmt = n => {
    const neg = n < 0;
    n = Math.abs(n);
    return (neg ? "-" : "") + currencySymbol + n.toFixed(2);
  };

  function refreshSummary() {
    let totalAssigned = 0;
    let totalSpent = 0;
    let totalOverspent = 0;

    budgetItems.forEach(item => {
      const assigned = Number(item.assigned);
      const spent = transactions
        .filter(t => t.item === item.name)
        .reduce((sum, t) => sum + Math.abs(t.amount), 0);
      const available = assigned - spent;
      const overspent = available < 0 ? Math.abs(available) : 0;

      totalAssigned += assigned;
      totalSpent += spent;
      totalOverspent += overspent;
    });

    const toBeBudgeted = budgetPool - totalAssigned;
    const availableCash = budgetPool - totalSpent;

    document.getElementById('total-pool-display').textContent = fmt(budgetPool);
    document.getElementById('available-cash-display').textContent = fmt(availableCash); // ✅ NEW
    document.getElementById('total-assigned-display').textContent = fmt(totalAssigned);
    document.getElementById('available-to-assign-display').textContent = fmt(toBeBudgeted);
    document.getElementById('overspent-display').textContent = fmt(totalOverspent);
  }
  function refreshBudgetItems() {
    const container = document.getElementById('items-container');
    container.innerHTML = '';
    budgetItems.forEach(item => {
      const tpl = document.getElementById('item-template').content.cloneNode(true);
      tpl.querySelector('[data-name]').textContent = item.name;
      tpl.querySelector('[data-goal]').textContent = 'Assigned: ' + fmt(item.assigned);
      const assigned = Number(item.assigned);
      const spent = transactions.filter(t => t.item === item.name).reduce((s, t) => s + Number(t.amount), 0);
      const available = assigned + spent;
      tpl.querySelector('[data-assigned]').textContent = fmt(assigned);
      tpl.querySelector('[data-spent]').textContent = fmt(Math.abs(spent));
      tpl.querySelector('[data-available]').textContent = fmt(available);
      const txContainer = tpl.querySelector('[data-transactions]');
      const recent = transactions.filter(t => t.item === item.name).slice(-3).reverse();
      recent.forEach(t => {
        const div = document.createElement('div');
        div.className = 'transaction';
        div.innerHTML = `<div>${t.payee} <span class="small">(${t.date})</span></div><div>${fmt(t.amount)}</div>`;
        txContainer.appendChild(div);
      });
      container.appendChild(tpl);
    });
    refreshSummary();
    refreshTransactionList();
    refreshItemOptions();
  }


function refreshBudgetManagementTable() {
  const list = document.getElementById('budget-category-list');
  list.innerHTML = '';

  budgetItems.forEach((item, index) => {
    const assigned = Number(item.assigned);
    const spent = transactions
      .filter(t => t.item === item.name)
      .reduce((sum, t) => sum + Math.abs(t.amount), 0);
    const available = assigned - spent;

    const row = document.createElement('tr');

    row.innerHTML = `
      <td class="p-2">${item.name}</td>
      <td class="p-2 text-right">${fmt(assigned)}</td>
      <td class="p-2 text-right">${fmt(spent)}</td>
      <td class="p-2 text-right">${fmt(available)}</td>
      <td class="p-2 text-center">
        <button class="btn btn-sm edit-btn" data-index="${index}">✏️</button>
        <button class="btn btn-sm delete-btn" data-index="${index}">🗑️</button>
      </td>
    `;

    list.appendChild(row);
  });







 document.querySelectorAll('.edit-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    const i = e.target.getAttribute('data-index');
    const item = budgetItems[i];
    document.getElementById('new-item-name').value = item.name;
    document.getElementById('new-item-amount').value = item.assigned;
    document.getElementById('item-modal').style.display = 'flex';
    
    editingItemIndex = i;  // Set the index of the item being edited

    document.getElementById('save-new-item').onclick = () => {
      const name = document.getElementById('new-item-name').value.trim();
      const amount = parseFloat(document.getElementById('new-item-amount').value);
      if (!name || isNaN(amount)) return;

      // Update the existing item
      if (editingItemIndex !== null) {
        budgetItems[editingItemIndex] = { name, assigned: amount };
        closeModals();
        refreshBudgetItems();
        refreshBudgetManagementTable();
        saveDataToFirestore();
        editingItemIndex = null; // Reset after editing
      }
    };
  });
});


document.querySelectorAll('.delete-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    const i = e.target.getAttribute('data-index');
    const item = budgetItems[i]; // Get the item to be deleted

    if (confirm(`Are you sure you want to delete "${item.name}" and all related transactions?`)) {
      // 1. Remove the item from the array
      budgetItems.splice(i, 1);

      // 2. Remove related transactions
      const originalLength = transactions.length;
      for (let j = transactions.length - 1; j >= 0; j--) {
        if (transactions[j].item === item.name) {
          transactions.splice(j, 1);
        }
      }

      console.log("✅ Item deleted from array:", item);
      console.log("✅ Updated budgetItems array:", budgetItems);
      console.log(`✅ Deleted ${originalLength - transactions.length} related transactions`);

      // 3. Refresh UI
      refreshBudgetItems();
      refreshBudgetManagementTable();
      refreshTransactionList(); // <-- Make sure this function exists

      // 4. Save changes to Firestore
      saveDataToFirestore();
    }
  });
});
}


// Show income modal when button clicked
document.getElementById('add-income-btn').addEventListener('click', () => {
  // reset fields
  const today = new Date().toISOString().slice(0,10);
  document.getElementById('income-date').value = today;
  document.getElementById('income-amount').value = '';
  document.getElementById('income-description').value = '';
  // show modal (same approach as your other modals)
  document.getElementById('income-modal').style.display = 'flex';
});

// Close handlers
document.getElementById('cancel-income').addEventListener('click', () => {
  document.getElementById('income-modal').style.display = 'none';
});
// close button (×)
document.getElementById('income-close-btn').addEventListener('click', () => {
  document.getElementById('income-modal').style.display = 'none';
});

// Save income
document.getElementById('save-income').addEventListener('click', (e) => {
  e.preventDefault();

  const date = document.getElementById('income-date').value || new Date().toISOString().slice(0,10);
  const amountRaw = document.getElementById('income-amount').value;
  const description = document.getElementById('income-description').value.trim() || 'Income';

  const amount = parseFloat(amountRaw);
  if (isNaN(amount) || amount <= 0) {
    alert('Please enter a valid income amount greater than 0.');
    return;
  }

  // Construct transaction — incomes stored as POSITIVE amounts
  const incomeTx = {
    payee: description,
    amount: Math.abs(amount),   // positive
    item: 'Income',             // or null if you prefer
    date: date
  };

  // Add to in-memory array
  transactions.push(incomeTx);

  // Add to budget pool / available money
  budgetPool = Number(budgetPool) + Number(amount);

  // Refresh UI — reuse your existing functions
  // refreshBudgetItems may re-render items & calls refreshSummary inside it
  if (typeof refreshBudgetItems === 'function') refreshBudgetItems();
  if (typeof refreshSummary === 'function') refreshSummary();
  if (typeof refreshAccounts === 'function') refreshAccounts();
  if (typeof refreshTransactionList === 'function') refreshTransactionList();

  // Save to Firestore (reuse your function)
  if (typeof saveDataToFirestore === 'function') saveDataToFirestore();

  // Close modal and clear inputs
  document.getElementById('income-modal').style.display = 'none';
  document.getElementById('income-amount').value = '';
  document.getElementById('income-description').value = '';
});












document.getElementById('add-budget-category').addEventListener('click', () => {
  editingItemIndex = null;  // Reset to indicate that it's not an edit operation
  document.getElementById('new-item-name').value = '';
  document.getElementById('new-item-amount').value = '';
  document.getElementById('item-warning').style.display = 'none';
  document.getElementById('item-modal').style.display = 'flex';

  document.getElementById('save-new-item').onclick = () => {
    const name = document.getElementById('new-item-name').value.trim();
    const amount = parseFloat(document.getElementById('new-item-amount').value);
    const totalAssigned = budgetItems.reduce((s, i) => s + Number(i.assigned), 0);
    if (totalAssigned + amount > budgetPool) {
      document.getElementById('item-warning').textContent = "Assigned amount exceeds available pool.";
      document.getElementById('item-warning').style.display = 'block';
      return;
    }

    // Add new item if it's not an edit
    if (editingItemIndex === null) {
      budgetItems.push({ name, assigned: amount });
    }
    
    closeModals();
    refreshBudgetItems();
    refreshBudgetManagementTable();
    saveDataToFirestore();
  };
});



async function updateToBeBudgeted(monthKey) {
  const userId = firebase.auth().currentUser.uid;
  const docRef = firebase.firestore().collection('budgetPools').doc(`${userId}_${monthKey}`);
  const docSnap = await docRef.get();

  let totalIncome = 0;
  let totalAssigned = 0;

  if (docSnap.exists) {
    totalIncome = docSnap.data().amount || 0;
  }

  const itemsSnap = await firebase.firestore()
    .collection('budgetItems')
    .where('userId', '==', userId)
    .where('monthKey', '==', monthKey)
    .get();

  itemsSnap.forEach(doc => {
    const item = doc.data();
    totalAssigned += parseFloat(item.assigned || 0);
  });

  const toBeBudgeted = totalIncome - totalAssigned;

  document.getElementById("to-be-budgeted").textContent = `₱${toBeBudgeted.toFixed(2)}`;
}








function populateBudgetMonthSelector() {
  const monthSelector = document.getElementById("budget-month-selector");
  if (!monthSelector) return;

  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();

  for (let i = -3; i <= 3; i++) {
    const date = new Date(currentYear, currentMonth + i);
    const monthYear = date.toLocaleString("default", { month: "long", year: "numeric" });

    const option = document.createElement("option");
    option.value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`; // e.g. "2025-08"
    option.textContent = monthYear;

    monthSelector.appendChild(option);
  }

  monthSelector.value = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
}







  function refreshTransactionList() {
    const list = document.getElementById('transactions-list');
    list.innerHTML = '';
    const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
    sorted.slice(0, 6).forEach(t => {
      const div = document.createElement('div');
      div.className = 'transaction';
      div.innerHTML = `<div><strong>${t.payee}</strong> <span class="small">${t.item} • ${t.date}</span></div><div>${fmt(t.amount)}</div>`;
      list.appendChild(div);
    });
  }

  function refreshItemOptions() {
    const sel = document.getElementById('tx-item');
    sel.innerHTML = '';
    budgetItems.forEach(i => {
      const o = document.createElement('option');
      o.value = i.name;
      o.textContent = i.name;
      sel.appendChild(o);
    });
  }

function closeModals() {
  document.getElementById('item-modal').style.display = 'none';
  document.getElementById('transaction-modal').style.display = 'none';
  document.getElementById('pool-modal').style.display = 'none';
  document.getElementById('account-modal').style.display = 'none'; // ✅ Add Account modal
  document.getElementById('item-warning').style.display = 'none';
}




// Function to save data to Firestore after an update
function saveDataToFirestore() {
  console.log("✅ Saving data to Firestore...");
  console.log("Current budgetItems array:", budgetItems);

  db.collection("budgets").doc("default").set({
    items: budgetItems,
    transactions: transactions,
    accounts: accounts,
    pool: budgetPool
  }).then(() => {
    console.log("✅ Data saved to Firestore.");
  }).catch(err => {
    console.error("❌ Error saving data:", err);
  });
}



  // --- Events ---
  document.getElementById('add-item-btn').addEventListener('click', () => {
    document.getElementById('new-item-name').value = '';
    document.getElementById('new-item-amount').value = '';
    document.getElementById('item-warning').style.display = 'none';
    document.getElementById('item-modal').style.display = 'flex';
  });

  document.getElementById('add-transaction-btn').addEventListener('click', () => {
    if (budgetItems.length === 0) {
      alert("Please add a budget item before creating a transaction.");
      return;
    }
    document.getElementById('tx-payee').value = '';
    document.getElementById('tx-amount').value = '';
    document.getElementById('tx-date').value = new Date().toISOString().slice(0, 10);
    refreshItemOptions();
    document.getElementById('transaction-modal').style.display = 'flex';
  });

  document.querySelectorAll('[data-close]').forEach(b => b.addEventListener('click', closeModals));
  document.getElementById('cancel-new-item').addEventListener('click', closeModals);
  document.getElementById('cancel-tx').addEventListener('click', closeModals);
  document.getElementById('cancel-pool').addEventListener('click', closeModals);

  document.getElementById('save-new-item').onclick = () => {
  const name = document.getElementById('new-item-name').value.trim();
  const amount = parseFloat(document.getElementById('new-item-amount').value);

  if (!name || isNaN(amount)) return;

  // Check if we're in editing mode or adding a new item
  if (editingItemIndex !== null) {
    // Update existing item
    budgetItems[editingItemIndex] = { name, assigned: amount };
  } else {
    // Add new item
    budgetItems.push({ name, assigned: amount });
  }

  closeModals();
  refreshBudgetItems();
  refreshBudgetManagementTable();
  saveDataToFirestore();

  // Reset editingItemIndex after update
  editingItemIndex = null; 
};


  document.getElementById('save-tx').addEventListener('click', () => {
  const payee = document.getElementById('tx-payee').value.trim();
  const amountInput = document.getElementById('tx-amount').value.trim();
  const item = document.getElementById('tx-item').value || (budgetItems[0]?.name || '');
  const date = document.getElementById('tx-date').value || new Date().toISOString().slice(0, 10);

  // Validate Payee
  if (!payee) {
    alert("Please enter a payee.");
    return;
  }

  // Validate Amount
  if (!amountInput || isNaN(parseFloat(amountInput)) || parseFloat(amountInput) <= 0) {
    alert("Please enter a valid amount greater than 0.");
    return;
  }

  // Validate Item
  if (!item) {
    alert("No budget item selected.");
    return;
  }

  let amount = parseFloat(amountInput);
  amount = -Math.abs(amount); // Always save as negative (expense)

  transactions.push({ payee, amount, item, date });
  closeModals();
  refreshBudgetItems();
  saveDataToFirestore();
});


  document.getElementById('edit-pool-btn').addEventListener('click', () => {
    document.getElementById('pool-input').value = budgetPool;
    document.getElementById('pool-modal').style.display = 'flex';
  });



document.addEventListener("DOMContentLoaded", () => {
  // Set initial active section (default to 'overview')
  const initialSection = 'overview'; // Change to 'budgets' if you want Budgets section to be active by default
  const initialButton = document.querySelector(`[data-section="${initialSection}"]`);
  
  // Activate the default button (Overview or Budgets)
  if (initialButton) {
    initialButton.classList.add('active');
  }

  // Hide all sections and show the default one (overview or budgets)
  document.querySelectorAll('.section').forEach(sec => {
    const sectionId = sec.getAttribute('data-section-id');
    if (sectionId === initialSection) {
      sec.style.display = 'block'; // Show the default section (Overview or Budgets)
    } else {
      sec.style.display = 'none'; // Hide other sections
    }
  });

  // Populate both month selectors
  populateBudgetMonthSelector();
  populateReportMonthSelector();

  // Reports Section: Select current month and load report
  const reportSelector = document.getElementById("report-month-selector");
  if (reportSelector && reportSelector.options.length > 0) {
    reportSelector.selectedIndex = 0;
    const selectedMonth = reportSelector.value;
    renderSpendingReport(selectedMonth); // This will render the report
  }

  // Handle sidebar button clicks
  document.querySelectorAll('.nav button').forEach(btn => {
    btn.addEventListener('click', () => {
      const sectionId = btn.getAttribute('data-section');
      console.log(`Clicked button with section: ${sectionId}`); // Debugging clicked button

      // Remove 'active' class from all buttons
      document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
      // Add 'active' class to clicked button
      btn.classList.add('active');

      // Hide all sections, then show the one that matches the clicked sectionId
      document.querySelectorAll('.section').forEach(sec => {
        const secId = sec.getAttribute('data-section-id');
        if (secId === sectionId) {
          sec.style.display = 'block'; // Show the selected section
        } else {
          sec.style.display = 'none'; // Hide the other sections
        }
      });

      // Special handling for budgets section
      if (sectionId === 'budgets') {
        refreshBudgetManagementTable(); // Ensure this function is correctly defined
      }
    });
  });
});










// === BUDGETS ===

document.getElementById("budget-month-selector").addEventListener("change", (e) => {
  const monthKey = e.target.value; // e.g., "2025-08"
  updateToBeBudgeted(monthKey);
  loadBudgetItems(monthKey); // Optional: Load the budget table for this month
});







// === ACCOUNTS ===

document.getElementById('add-account').addEventListener('click', () => {
  document.getElementById('account-name').value = '';
  document.getElementById('account-balance').value = '';
  document.getElementById('account-modal').style.display = 'flex';
});

document.getElementById('cancel-account').addEventListener('click', () => {
  document.getElementById('account-modal').style.display = 'none';
});


document.getElementById('save-account').addEventListener('click', () => {
  const nameInput = document.getElementById('account-name');
  const balanceInput = document.getElementById('account-balance');
  const name = nameInput.value.trim();
  const balance = parseFloat(balanceInput.value.trim());

  let valid = true;

  // Hide all warnings first
  document.getElementById('account-name-warning').style.display = 'none';
  document.getElementById('account-balance-warning').style.display = 'none';

  // Validate name
  if (!name) {
    document.getElementById('account-name-warning').style.display = 'block';
    valid = false;
  }

  // Validate balance
  if (isNaN(balance)) {
    document.getElementById('account-balance-warning').style.display = 'block';
    valid = false;
  }

  if (!valid) return;

  // Add to accounts and update UI
  accounts.push({ name, balance });
  closeModals();
  refreshAccounts();
  saveDataToFirestore();

  // Clear input fields
  nameInput.value = '';
  balanceInput.value = '';
});


document.getElementById('cancel-account').addEventListener('click', closeModals);

function refreshAccounts() {
  const container = document.getElementById('accounts-list');
  container.innerHTML = '';
  accounts.forEach(acc => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<strong>${acc.name}</strong><br/>Balance: ${fmt(acc.balance)}`;
    container.appendChild(div);
  });
}





  document.getElementById('save-pool').addEventListener('click', () => {
    const v = parseFloat(document.getElementById('pool-input').value);
    if (!isNaN(v) && v >= 0) {
      budgetPool = v;
    }
    closeModals();
    refreshBudgetItems();
    saveDataToFirestore();
  });

  document.getElementById('new-item-amount').addEventListener('input', () => {
    const amt = parseFloat(document.getElementById('new-item-amount').value) || 0;
    const totalAssigned = budgetItems.reduce((s, i) => s + Number(i.assigned), 0);
    if (totalAssigned + amt > budgetPool) {
      document.getElementById('item-warning').textContent = "Assigned amount exceeds available pool.";
      document.getElementById('item-warning').style.display = 'block';
    } else {
      document.getElementById('item-warning').style.display = 'none';
    }
  });

document.querySelectorAll('.nav button').forEach(btn => {
  btn.addEventListener('click', () => {
    const sectionId = btn.getAttribute('data-section');
    console.log(`Clicked button with section: ${sectionId}`); // Debug

    // Remove 'active' class from all buttons
    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
    // Add 'active' class to clicked button
    btn.classList.add('active');

    // Hide all sections, then show the one that matches the clicked sectionId
    document.querySelectorAll('.section').forEach(sec => {
      const secId = sec.getAttribute('data-section-id');
      console.log(`Checking section: ${secId}`); // Debug section check
      if (secId === sectionId) {
        console.log(`Showing section: ${secId}`); // Debug when section is shown
        sec.style.display = 'block';
      } else {
        sec.style.display = 'none';
      }
    });

    // Special handling for budgets
    if (sectionId === 'budgets') {
      console.log('Refreshing budget management table...');
      refreshBudgetManagementTable(); // Ensure this works as expected
    }
  });
});




// === Reports ===
async function populateReportMonthSelector() {
  const monthSelector = document.getElementById("report-month-selector");
  if (!monthSelector) return;

  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();

  monthSelector.innerHTML = '';
  for (let i = -3; i <= 3; i++) {
    const date = new Date(currentYear, currentMonth + i);
    const monthYear = date.toLocaleString("default", { month: "long", year: "numeric" });

    const option = document.createElement("option");
    option.value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    option.textContent = monthYear;
    monthSelector.appendChild(option);
  }

  monthSelector.value = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

  const selectedMonth = monthSelector.value;

  // Fetch transactions first
  window.transactions = await fetchTransactions();

  renderSpendingReport(selectedMonth);
  loadReportTable(selectedMonth);
}

document.getElementById("report-month-selector").addEventListener("change", (e) => {
  const selectedMonth = e.target.value;
  renderSpendingReport(selectedMonth);
  loadReportTable(selectedMonth);
});

function renderSpendingReport(monthKey) {
  let filtered;
  if (monthKey === "All") {
    filtered = [...transactions];
  } else {
    filtered = transactions.filter(tx => tx.date.slice(0, 7) === monthKey);
  }

  const spendingByCategory = {};
  let totalSpent = 0;
  let totalIncome = 0;

  filtered.forEach(tx => {
    const category = tx.item || "Uncategorized";
    const amount = Math.abs(tx.amount);

    if (tx.amount < 0) {
      // Expense
      totalSpent += amount;
      spendingByCategory[category] = (spendingByCategory[category] || 0) + amount;
    } else {
      // Income
      totalIncome += amount;
    }
  });

  const summaryDiv = document.getElementById("monthly-summary");
  if (filtered.length === 0) {
    summaryDiv.innerHTML = "<p>No data available for this month.</p>";
    if (window.spendingChart) window.spendingChart.destroy();
    return;
  }

  const topCategory = Object.entries(spendingByCategory).sort((a, b) => b[1] - a[1])[0];

  const formattedMonth = monthKey === "All"
    ? "All Months"
    : new Date(monthKey + "-01").toLocaleString("default", { month: "long", year: "numeric" });

 summaryDiv.innerHTML = `
  <h2 class="text-lg font-semibold mb-2">Summary for ${formattedMonth}</h2>
  <p><strong>Total Spent:</strong> ${totalSpent.toLocaleString()}</p>
  <p><strong>Total Income:</strong> ${totalIncome.toLocaleString()}</p>
  <p><strong>Transactions:</strong> ${filtered.length}</p>
  <p><strong>Top Category:</strong> ${topCategory ? `${topCategory[0]} (${topCategory[1].toLocaleString()})` : 'N/A'}</p>
  <hr class="my-2">
`;


  // === Chart Rendering ===
  const canvas = document.getElementById("spending-chart");
  const ctx = canvas.getContext("2d");

  // Scale for high DPI displays
  canvas.width = canvas.offsetWidth * window.devicePixelRatio;
  canvas.height = canvas.offsetHeight * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

  if (window.spendingChart) window.spendingChart.destroy();

  window.spendingChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(spendingByCategory),
      datasets: [{
        label: 'Spending by Category',
        data: Object.values(spendingByCategory),
        backgroundColor: Object.keys(spendingByCategory).map(() =>
          `hsl(${Math.random() * 360}, 60%, 70%)`),
        borderColor: '#fff',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
       tooltip: {
  callbacks: {
    label: tooltipItem =>
      `${tooltipItem.label}: ${tooltipItem.raw.toLocaleString()}`
  }
},
        title: {
          display: true,
          text: `Spending Breakdown (${formattedMonth})`
        }
      },
      scales: {
        x: { title: { display: true, text: 'Category' } },
        y: {
          title: { display: true, text: 'Amount (₱)' },
          beginAtZero: true
        }
      }
    }
  });
}


function loadReportTable(monthKey) {
  const tableBody = document.getElementById('reportTableBody');
  if (!tableBody) return;

  tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Loading...</td></tr>';

  let filtered;
  if (monthKey === "All") {
    filtered = [...transactions];
  } else {
    filtered = transactions.filter(tx => tx.date.slice(0, 7) === monthKey);
  }

  if (!filtered.length) {
    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No data available</td></tr>';
    return;
  }

  tableBody.innerHTML = filtered.map(tx => `
    <tr>
      <td>${tx.date}</td>
      <td>${tx.item || 'Uncategorized'}</td>
      <td>${tx.payee || ''}</td>
     <td class="${tx.amount < 0 ? 'negative' : 'positive'}">${Math.abs(tx.amount).toLocaleString()}</td>

      <td>${tx.amount < 0 ? 'Expense' : 'Income'}</td>
    </tr>
  `).join('');
}


// === Firestore Fetch ===
function fetchTransactions() {
  return new Promise((resolve, reject) => {
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const userId = user.uid;

        try {
          const docRef = db.collection("budget").doc(userId);
          const docSnap = await docRef.get();

          if (docSnap.exists) {
            resolve(docSnap.data().transactions || []);
          } else {
            console.warn("No transactions found for this user.");
            resolve([]);
          }
        } catch (error) {
          console.error("Error fetching transactions:", error);
          reject(error);
        }
      } else {
        console.warn("User not logged in.");
        resolve([]);
      }
    });
  });
}


document.getElementById("download-report-btn").addEventListener("click", function () {
  const monthSelector = document.getElementById("report-month-selector");
  const selectedMonth = monthSelector.value;

  if (!selectedMonth) {
    alert("Please select a month before downloading the report.");
    return;
  }

  const summaryElement = document.getElementById("monthly-summary");

  // Extract individual summary pieces by querying the elements or parsing innerHTML
  // Assuming you rendered the summary like this in renderSpendingReport():
  //
  // <p><strong>Total Spent:</strong> ₱46,010</p>
  // <p><strong>Total Income:</strong> ₱51,950</p>
  // <p><strong>Transactions:</strong> 23</p>
  // <p><strong>Top Category:</strong> Elea's Birthday (₱21,900)</p>

  // Parse summary fields reliably:
  const parser = new DOMParser();
  const doc = parser.parseFromString(summaryElement.innerHTML, "text/html");
  const ps = doc.querySelectorAll("p");

  let totalSpent = "";
  let totalIncome = "";
  let transactionsCount = "";
  let topCategory = "";

  ps.forEach(p => {
    const text = p.textContent.trim();
    if (text.startsWith("Total Spent:")) totalSpent = text;
    else if (text.startsWith("Total Income:")) totalIncome = text;
    else if (text.startsWith("Transactions:")) transactionsCount = text;
    else if (text.startsWith("Top Category:")) topCategory = text;
  });

  // Prepare summary data for Excel:
  const formattedMonth = selectedMonth === "All"
    ? "All Months"
    : new Date(selectedMonth + "-01").toLocaleString("default", { month: "long", year: "numeric" });

  const summaryData = [
    [`Summary for ${formattedMonth}`],
    [totalSpent],
    [totalIncome],
    [transactionsCount],
    [topCategory]
  ];

  // Blank row for spacing
  summaryData.push([]);

  // Table header
  const tableHeader = ["Date", "Category", "Description", "Amount", "Type"];

  // Extract transactions table rows
  const tableBody = document.querySelectorAll("#reportTableBody tr");
  const transactionData = [];
  tableBody.forEach(row => {
    const cols = row.querySelectorAll("td");
    if (cols.length > 0 && cols[0].innerText.trim() !== "No data available") {
      transactionData.push([
        cols[0].innerText.trim(),
        cols[1].innerText.trim(),
        cols[2].innerText.trim(),
        cols[3].innerText.trim(),
        cols[4].innerText.trim()
      ]);
    }
  });

  // Combine all into one sheet data
  const sheetData = [...summaryData, tableHeader, ...transactionData];

  // Create worksheet and workbook
  const ws = XLSX.utils.aoa_to_sheet(sheetData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Report");

  // Download as Excel
  XLSX.writeFile(wb, `Monthly_Report_${selectedMonth}.xlsx`);
});








document.getElementById('save-settings').addEventListener('click', () => {
  const selectedCurrency = document.getElementById('currency-selector').value; // <-- note id 'currency-selector'

  switch (selectedCurrency) {
    case 'PHP':
      currencyCode = 'PHP';
      currencySymbol = '₱';
      break;
    case 'USD':
      currencyCode = 'USD';
      currencySymbol = '$';
      break;
    case 'EUR':
      currencyCode = 'EUR';
      currencySymbol = '€';
      break;
    case 'GBP':
      currencyCode = 'GBP';
      currencySymbol = '£';
      break;
    case 'KES':
      currencyCode = 'KES';
      currencySymbol = 'KES ';
      break;
    default:
      currencyCode = selectedCurrency;
      currencySymbol = selectedCurrency + ' ';
  }

  // Close settings modal
  document.getElementById('settings-modal').style.display = 'none';

  // Refresh UI to reflect new currency
  refreshBudgetItems();
  refreshSummary();
  if (typeof refreshTransactionList === 'function') refreshTransactionList();
  if (typeof refreshAccounts === 'function') refreshAccounts();
});













async function loadDataFromFirestore() {
  try {
    const doc = await db.collection("budgets").doc("default").get();
    if (doc.exists) {
      const data = doc.data();
      
      // Log the entire data object to ensure you're receiving the expected structure
      
      // Reset arrays before pushing new data
      budgetItems.length = 0;
      transactions.length = 0;

      // Push data into arrays
      budgetItems.push(...(data.items || []));
      transactions.push(...(data.transactions || []));
      budgetPool = data.pool || 0;


      // Refresh the UI
      refreshBudgetItems();
      accounts.length = 0;
      accounts.push(...(data.accounts || []));
      refreshAccounts();
      
    } else {
      console.log("📭 No existing data found in Firestore.");
    }
  } catch (error) {
    console.error("❌ Failed to load data from Firestore:", error);
  }
} // Ensure this is closed properly



 // Logout button handler
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
      const user = firebase.auth().currentUser;
      if (!user) {
        alert("No user logged in.");
        return;
      }
      const uid = user.uid;
      // Update sessionActive field to false on Firestore user document
      await firebase.firestore().collection('users').doc(uid).update({
        sessionActive: false
      });
      // Sign out the user
      await firebase.auth().signOut();
      // Redirect to login page
      window.location.href = 'login.html';
    } catch (error) {
      alert("Logout failed: " + error.message);
    }
  });







  // Load Firestore data on start
  loadDataFromFirestore();
</script>



</html>
